name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual deploys

# Only run one deploy at a time
concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  # Wait for CI to pass before deploying
  ci-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check CI status
        uses: actions/github-script@v7
        with:
          script: |
            // Get the latest CI workflow run for this commit
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              head_sha: context.sha,
              per_page: 1
            });

            if (runs.data.workflow_runs.length === 0) {
              core.setFailed('No CI workflow run found for this commit');
              return;
            }

            const run = runs.data.workflow_runs[0];
            if (run.conclusion !== 'success') {
              core.setFailed(`CI workflow ${run.conclusion}. Deploy blocked.`);
            }

  deploy-backend:
    needs: ci-check
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys"

          echo "Deployment triggered on Render"

  # Vercel auto-deploys on push, but we can notify on completion
  notify:
    needs: deploy-backend
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend (Vercel) | Auto-deployed on push |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend (Render) | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://strictly-dancing.vercel.app" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: https://strictly-dancing-api.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "- API Docs: https://strictly-dancing-api.onrender.com/docs" >> $GITHUB_STEP_SUMMARY
